<div class="max-w-4xl mx-auto mt-8">
  <!-- The *ngIf now ensures 'files' is a valid array before we try to use it -->
  <div *ngIf="filesMeta$ | async as files" class="bg-white rounded-lg shadow-2xl overflow-hidden">

    <!-- Header -->
    <div class="p-6 border-b">
      <div class="flex justify-between items-center">
        <div>
          <!-- FIX 1: Replaced 'files[0]?.filename' with a safer check -->
          <h2 class="text-2xl font-bold text-gray-800">{{ (files.length > 0 ? files[0].filename : 'Batch Download') }}</h2>
          <p class="text-sm text-gray-500">
            <span>{{ files.length }} Files</span>
            <span class="mx-2">|</span>
            <!-- FIX 2: Replaced invalid syntax with a call to our new method -->
            <span>Total Size: {{ calculateTotalSize(files) / 1024 / 1024 | number:'1.2-2' }} MB</span>
            <span class="mx-2">|</span>
            <span class="text-orange-500 font-semibold">Expires in 1w</span> <!-- Placeholder -->
          </p>
        </div>
        <div class="flex items-center space-x-2">
            <a [href]="batchUploadService.batchApiUrl + '/download-zip/' + batchId"
              class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors duration-300 flex items-center shrink-0">
              <mat-icon class="mr-2">folder_zip</mat-icon>
              Download All
            </a>
        </div>
      </div>
    </div>

    <!-- File List (No changes needed below this line) -->
    <div class="p-4">
      <div class="space-y-2">
        <!-- File Item -->
        <div *ngFor="let file of files" class="flex items-center p-3 rounded-lg hover:bg-gray-100 transition-colors duration-200">
          <!-- File Icon -->
          <div class="mr-4">
            <ng-container [ngSwitch]="getFileType(file.filename)">
              <mat-icon *ngSwitchCase="'image'" class="text-purple-500">image</mat-icon>
              <mat-icon *ngSwitchCase="'video'" class="text-red-500">videocam</mat-icon>
              <mat-icon *ngSwitchCase="'pdf'" class="text-orange-500">picture_as_pdf</mat-icon>
              <mat-icon *ngSwitchCase="'zip'" class="text-yellow-600">folder_zip</mat-icon>
              <mat-icon *ngSwitchDefault class="text-blue-500">article</mat-icon>
            </ng-container>
          </div>
          
          <!-- File Name and Size -->
          <div class="flex-grow">
            <p class="font-semibold text-gray-800 break-all">{{ file.filename }}</p>
            <p class="text-sm text-gray-500">{{ file.size_bytes / 1024 | number:'1.1-1' }} KB</p>
          </div>

          <!-- Action Buttons -->
          <div class="ml-4 flex items-center space-x-2 shrink-0">
            <!-- NEW PREVIEW BUTTON: Hidden for ZIPs -->
            <button *ngIf="!file.filename.toLowerCase().endsWith('.zip')" 
                    mat-icon-button 
                    (click)="openPreview(file)"
                    matTooltip="Preview File">
              <mat-icon class="text-gray-600 hover:text-blue-600">visibility</mat-icon>
            </button>
            <a [href]="batchUploadService.getStreamUrl(file._id)" 
              download
              mat-icon-button
              matTooltip="Download File">
              <mat-icon class="text-gray-600 hover:text-green-600">download</mat-icon>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template #loadingOrError>
    <div class="text-center py-16">
      <mat-spinner></mat-spinner>
      <p class="mt-4 text-gray-500 text-lg">Loading batch information...</p>
    </div>
  </ng-template>
</div>