<!-- Reports & Export Header -->
<div class="page-header">
  <h1>Reports & Export</h1>
  <p>Generate comprehensive reports and export data in multiple formats</p>
</div>

<!-- Loading Spinner -->
<div *ngIf="loading" class="loading-container">
  <mat-spinner></mat-spinner>
  <p>Generating report...</p>
</div>

<!-- Tab Navigation -->
<mat-tab-group [selectedIndex]="getTabIndex()" (selectedIndexChange)="onTabIndexChange($event)">
  
  <!-- GENERATE REPORTS TAB -->
  <mat-tab label="Generate Reports">
    <div class="tab-content">
      <!-- Report Generation Form -->
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>Generate Standard Report</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <form class="report-form">
            <div class="form-row">
              <mat-form-field>
                <mat-label>Report Type</mat-label>
                <mat-select [(ngModel)]="reportForm.report_type" name="reportType">
                  <mat-option *ngFor="let type of reportTypes" [value]="type.value">
                    {{ type.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field>
                <mat-label>Export Format</mat-label>
                <mat-select [(ngModel)]="reportForm.export_format" name="exportFormat">
                  <mat-option *ngFor="let format of exportFormats" [value]="format.value">
                    {{ format.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field>
                <mat-label>From Date</mat-label>
                <input matInput type="date" [(ngModel)]="reportForm.date_from" name="dateFrom">
              </mat-form-field>

              <mat-form-field>
                <mat-label>To Date</mat-label>
                <input matInput type="date" [(ngModel)]="reportForm.date_to" name="dateTo">
              </mat-form-field>
            </div>

            <!-- User Activity Options -->
            <div *ngIf="reportForm.report_type === 'user_activity'" class="options-section">
              <h4>User Activity Options</h4>
              <mat-checkbox [(ngModel)]="reportForm.include_inactive" name="includeInactive">
                Include Inactive Users
              </mat-checkbox>
            </div>

            <!-- Storage Usage Options -->
            <div *ngIf="reportForm.report_type === 'storage_usage'" class="options-section">
              <h4>Storage Usage Options</h4>
              <mat-form-field>
                <mat-label>Group By</mat-label>
                <mat-select [(ngModel)]="reportForm.group_by" name="groupBy">
                  <mat-option *ngFor="let option of storageGroupByOptions" [value]="option.value">
                    {{ option.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </form>
        </mat-card-content>
        <mat-card-actions>
          <button mat-raised-button color="primary" (click)="generateReport()" [disabled]="loading">
            <mat-icon>assessment</mat-icon>
            Generate Report
          </button>
        </mat-card-actions>
      </mat-card>

      <!-- Generated Report Display -->
      <mat-card *ngIf="currentReport" class="report-display">
        <mat-card-header>
          <mat-card-title>{{ getReportTypeLabel(reportType) }}</mat-card-title>
          <div class="export-actions">
            <button mat-button (click)="exportCurrentReport('json')">
              <mat-icon>download</mat-icon>
              Export JSON
            </button>
            <button mat-button (click)="exportCurrentReport('csv')">
              <mat-icon>download</mat-icon>
              Export CSV
            </button>
            <button mat-icon-button (click)="clearCurrentReport()">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </mat-card-header>
        <mat-card-content>
          <!-- System Overview Report -->
          <div *ngIf="isSystemOverviewReport(currentReport)" class="system-overview-report">
            <div class="report-info">
              <p><strong>Generated:</strong> {{ formatDate(currentReport.report_info.generated_at) }}</p>
              <p><strong>Period:</strong> {{ formatDate(currentReport.report_info.period.from) }} to {{ formatDate(currentReport.report_info.period.to) }} ({{ currentReport.report_info.period.days }} days)</p>
              <p><strong>Generated by:</strong> {{ currentReport.report_info.generated_by }}</p>
            </div>

            <div class="report-sections">
              <!-- User Statistics -->
              <div class="report-section">
                <h3>User Statistics</h3>
                <div class="stats-grid">
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.user_statistics.total_users }}</span>
                    <span class="stat-label">Total Users</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.user_statistics.active_users }}</span>
                    <span class="stat-label">Active Users</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.user_statistics.new_users_in_period }}</span>
                    <span class="stat-label">New Users</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.user_statistics.growth_rate | number:'1.1-1' }}%</span>
                    <span class="stat-label">Growth Rate</span>
                  </div>
                </div>
              </div>

              <!-- File Statistics -->
              <div class="report-section">
                <h3>File Statistics</h3>
                <div class="stats-grid">
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.file_statistics.total_files }}</span>
                    <span class="stat-label">Total Files</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.file_statistics.files_uploaded_in_period }}</span>
                    <span class="stat-label">Files in Period</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.file_statistics.total_storage_gb }} GB</span>
                    <span class="stat-label">Total Storage</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.file_statistics.average_file_size_mb }} MB</span>
                    <span class="stat-label">Avg File Size</span>
                  </div>
                </div>

                <div class="file-type-distribution" *ngIf="currentReport.file_statistics.type_distribution.length > 0">
                  <h4>File Type Distribution</h4>
                  <div class="type-list">
                    <div *ngFor="let type of currentReport.file_statistics.type_distribution" class="type-item">
                      <span class="type-name">{{ type.type }}</span>
                      <span class="type-count">{{ type.count }} files</span>
                      <span class="type-size">{{ type.size_gb }} GB</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- System Performance -->
              <div class="report-section">
                <h3>System Performance</h3>
                <div class="stats-grid">
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.system_performance.uptime_percentage }}%</span>
                    <span class="stat-label">Uptime</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.system_performance.average_response_time_ms }}ms</span>
                    <span class="stat-label">Avg Response Time</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.system_performance.total_api_requests }}</span>
                    <span class="stat-label">API Requests</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.system_performance.error_rate_percentage }}%</span>
                    <span class="stat-label">Error Rate</span>
                  </div>
                </div>
              </div>

              <!-- Growth Metrics -->
              <div class="report-section">
                <h3>Growth Metrics</h3>
                <div class="stats-grid">
                  <div class="stat-item">
                    <span class="stat-value" [class.positive]="currentReport.growth_metrics.user_growth_percentage > 0" [class.negative]="currentReport.growth_metrics.user_growth_percentage < 0">
                      {{ currentReport.growth_metrics.user_growth_percentage | number:'1.1-1' }}%
                    </span>
                    <span class="stat-label">User Growth</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value" [class.positive]="currentReport.growth_metrics.file_growth_percentage > 0" [class.negative]="currentReport.growth_metrics.file_growth_percentage < 0">
                      {{ currentReport.growth_metrics.file_growth_percentage | number:'1.1-1' }}%
                    </span>
                    <span class="stat-label">File Growth</span>
                  </div>
                </div>
              </div>

              <!-- Admin Activity -->
              <div class="report-section" *ngIf="currentReport.admin_activity.top_actions.length > 0">
                <h3>Top Admin Actions</h3>
                <div class="action-list">
                  <div *ngFor="let action of currentReport.admin_activity.top_actions" class="action-item">
                    <span class="action-name">{{ action.action }}</span>
                    <span class="action-count">{{ action.count }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- User Activity Report -->
          <div *ngIf="isUserActivityReport(currentReport)" class="user-activity-report">
            <div class="report-info">
              <p><strong>Generated:</strong> {{ formatDate(currentReport.report_info.generated_at) }}</p>
              <p><strong>Period:</strong> {{ formatDate(currentReport.report_info.period.from) }} to {{ formatDate(currentReport.report_info.period.to) }}</p>
            </div>

            <div class="report-sections">
              <div class="report-section">
                <h3>Activity Summary</h3>
                <div class="stats-grid">
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.summary.total_users_analyzed }}</span>
                    <span class="stat-label">Users Analyzed</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.summary.active_users_in_period }}</span>
                    <span class="stat-label">Active Users</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.summary.total_files_in_period }}</span>
                    <span class="stat-label">Files Uploaded</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.summary.average_files_per_active_user | number:'1.1-1' }}</span>
                    <span class="stat-label">Avg Files per User</span>
                  </div>
                </div>
              </div>

              <div class="report-section" *ngIf="currentReport.summary.top_users_by_activity.length > 0">
                <h3>Top Active Users</h3>
                <div class="user-list">
                  <div *ngFor="let user of currentReport.summary.top_users_by_activity" class="user-item">
                    <span class="user-email">{{ user.email }}</span>
                    <span class="user-files">{{ user.files_in_period }} files</span>
                    <span class="user-storage">{{ user.storage_mb }} MB</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Storage Usage Report -->
          <div *ngIf="isStorageUsageReport(currentReport)" class="storage-usage-report">
            <div class="report-info">
              <p><strong>Generated:</strong> {{ formatDate(currentReport.report_info.generated_at) }}</p>
              <p><strong>Period:</strong> {{ formatDate(currentReport.report_info.period.from) }} to {{ formatDate(currentReport.report_info.period.to) }}</p>
              <p><strong>Grouped by:</strong> {{ currentReport.report_info.group_by }}</p>
            </div>

            <div class="report-sections">
              <div class="report-section">
                <h3>Storage Summary</h3>
                <div class="stats-grid">
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.summary.total_files }}</span>
                    <span class="stat-label">Total Files</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.summary.total_storage_gb }} GB</span>
                    <span class="stat-label">Total Storage</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.summary.files_in_period }}</span>
                    <span class="stat-label">Files in Period</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ currentReport.summary.average_file_size_mb }} MB</span>
                    <span class="stat-label">Avg File Size</span>
                  </div>
                </div>
              </div>

              <div class="report-section" *ngIf="currentReport.detailed_breakdown.length > 0">
                <h3>Detailed Breakdown</h3>
                <div class="breakdown-table">
                  <div class="table-header">
                    <span *ngFor="let key of Object.keys(currentReport.detailed_breakdown[0])">{{ key | titlecase }}</span>
                  </div>
                  <div *ngFor="let item of currentReport.detailed_breakdown" class="table-row">
                    <span *ngFor="let key of Object.keys(item)">{{ item[key] }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Custom Report -->
          <div *ngIf="reportType === 'custom'" class="custom-report">
            <div class="report-info">
              <p><strong>Report:</strong> {{ currentReport.report_info.title }}</p>
              <p><strong>Description:</strong> {{ currentReport.report_info.description || 'No description' }}</p>
              <p><strong>Generated:</strong> {{ formatDate(currentReport.report_info.generated_at) }}</p>
            </div>

            <div class="report-sections" *ngIf="currentReport?.results">
              <div *ngFor="let source of Object.keys(currentReport.results)" class="report-section">
                <h3>{{ source | titlecase }} ({{ currentReport.results[source].count }} records)</h3>
                <div class="data-preview" *ngIf="currentReport.results[source].data.length > 0">
                  <div class="table-container">
                    <div class="table-header">
                      <span *ngFor="let key of Object.keys(currentReport.results[source].data[0])">{{ key | titlecase }}</span>
                    </div>
                    <div *ngFor="let item of currentReport.results[source].data.slice(0, 10)" class="table-row">
                      <span *ngFor="let key of Object.keys(item)">{{ item[key] }}</span>
                    </div>
                    <div *ngIf="currentReport.results[source].data.length > 10" class="table-note">
                      Showing first 10 of {{ currentReport.results[source].data.length }} records. Export for full data.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </mat-tab>

  <!-- TEMPLATES TAB -->
  <mat-tab label="Report Templates">
    <div class="tab-content">
      <mat-card class="templates-list">
        <mat-card-header>
          <mat-card-title>Available Report Templates</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="templates.length === 0" class="no-data">
            <mat-icon>description</mat-icon>
            <p>No report templates available</p>
          </div>

          <div *ngFor="let template of templates" class="template-item">
            <div class="template-info">
              <h3>{{ template.name }}</h3>
              <p>{{ template.description }}</p>
              <div class="template-details">
                <span class="template-type">Type: {{ template.type }}</span>
                <span class="template-period">Default Period: {{ template.default_period_days }} days</span>
              </div>
              <div class="template-includes">
                <span class="include-tag" *ngFor="let include of template.includes">{{ include }}</span>
              </div>
            </div>
            <div class="template-actions">
              <button mat-raised-button color="primary" (click)="useTemplate(template)">
                <mat-icon>play_arrow</mat-icon>
                Use Template
              </button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </mat-tab>

  <!-- CUSTOM REPORT BUILDER TAB -->
  <mat-tab label="Custom Reports">
    <div class="tab-content">
      <mat-card class="custom-form">
        <mat-card-header>
          <mat-card-title>Custom Report Builder</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <form class="custom-report-form">
            <div class="form-row">
              <mat-form-field>
                <mat-label>Report Title</mat-label>
                <input matInput [(ngModel)]="customReportForm.title" name="customTitle" placeholder="Enter report title">
              </mat-form-field>

              <mat-form-field>
                <mat-label>Export Format</mat-label>
                <mat-select [(ngModel)]="customReportForm.export_format" name="customExportFormat">
                  <mat-option *ngFor="let format of exportFormats" [value]="format.value">
                    {{ format.label }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>

            <mat-form-field>
              <mat-label>Description</mat-label>
              <textarea matInput [(ngModel)]="customReportForm.description" name="customDescription" rows="3" placeholder="Describe your custom report"></textarea>
            </mat-form-field>

            <div class="form-row">
              <mat-form-field>
                <mat-label>From Date</mat-label>
                <input matInput type="date" [(ngModel)]="customReportForm.date_from" name="customDateFrom">
              </mat-form-field>

              <mat-form-field>
                <mat-label>To Date</mat-label>
                <input matInput type="date" [(ngModel)]="customReportForm.date_to" name="customDateTo">
              </mat-form-field>
            </div>

            <div class="data-sources-section">
              <h4>Data Sources</h4>
              <div class="checkbox-group">
                <mat-checkbox 
                  *ngFor="let source of availableDataSources" 
                  [checked]="customReportForm.data_sources.includes(source.value)"
                  (change)="toggleDataSource($event, source.value)">
                  {{ source.label }}
                </mat-checkbox>
              </div>
            </div>

            <div class="fields-section">
              <h4>Fields to Include</h4>
              <div class="selected-fields">
                <mat-chip-set>
                  <mat-chip 
                    *ngFor="let field of customReportForm.fields" 
                    [removable]="true" 
                    (removed)="removeField(field)">
                    {{ field }}
                    <mat-icon matChipRemove>cancel</mat-icon>
                  </mat-chip>
                </mat-chip-set>
              </div>
              
              <div class="add-field">
                <mat-form-field>
                  <mat-label>Add Custom Field</mat-label>
                  <input matInput #fieldInput placeholder="Enter field name">
                </mat-form-field>
                <button mat-button type="button" (click)="addCustomField(fieldInput)">Add</button>
              </div>

              <div class="available-fields">
                <h5>Common Fields:</h5>
                <button 
                  mat-stroked-button 
                  *ngFor="let field of availableFields" 
                  [disabled]="customReportForm.fields.includes(field)"
                  (click)="addField(field)">
                  {{ field }}
                </button>
              </div>
            </div>
          </form>
        </mat-card-content>
        <mat-card-actions>
          <button mat-button (click)="resetCustomReport()">Reset</button>
          <button mat-raised-button color="primary" (click)="generateCustomReport()" [disabled]="loading">
            <mat-icon>build</mat-icon>
            Generate Custom Report
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  </mat-tab>

  <!-- SCHEDULED REPORTS TAB -->
  <mat-tab label="Scheduled Reports">
    <div class="tab-content">
      <mat-card class="scheduled-placeholder">
        <mat-card-header>
          <mat-card-title>Scheduled Reports</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="coming-soon">
            <mat-icon>schedule</mat-icon>
            <h3>Coming Soon</h3>
            <p>Scheduled report generation and automatic delivery features are under development.</p>
            <p>You will be able to:</p>
            <ul>
              <li>Schedule reports to run daily, weekly, or monthly</li>
              <li>Automatically deliver reports via email</li>
              <li>Set up recurring reports for stakeholders</li>
              <li>Manage report delivery schedules</li>
            </ul>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </mat-tab>
</mat-tab-group>