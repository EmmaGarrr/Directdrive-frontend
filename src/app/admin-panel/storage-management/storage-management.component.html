<div class="storage-management-container">
  <!-- Header with tabs -->
  <div class="header">
    <h2>Storage Management</h2>
    
    <!-- Storage type tabs -->
    <div class="storage-tabs">
      <button 
        *ngFor="let storage of storageTypes"
        [class.active]="activeStorage === storage.id"
        (click)="onStorageChange(storage.id)"
        class="tab-button"
      >
        <i [class]="storage.icon"></i>
        <span>{{ storage.name }}</span>
        <span class="badge" *ngIf="stats?.by_storage_type?.[storage.id]?.count">
          {{ stats?.by_storage_type?.[storage.id]?.count | number }}
        </span>
      </button>
    </div>
    
    <!-- View mode toggle -->
    <div class="view-controls">
      <button 
        class="view-toggle" 
        [class.active]="viewMode === 'list'"
        (click)="toggleViewMode('list')"
        title="List view"
      >
        <i class="fas fa-list"></i>
      </button>
      <button 
        class="view-toggle"
        [class.active]="viewMode === 'grid'"
        (click)="toggleViewMode('grid')"
        title="Grid view"
      >
        <i class="fas fa-th-large"></i>
      </button>
    </div>
  </div>
  
  <!-- Storage stats -->
  <div class="storage-stats" *ngIf="stats">
    <div class="stat-card">
      <i class="fas fa-hdd"></i>
      <div class="stat-details">
        <span class="stat-value">{{ stats?.by_storage_type?.[activeStorage]?.size_formatted || '0 B' }}</span>
        <span class="stat-label">Total Storage Used</span>
      </div>
    </div>
    <div class="stat-card">
      <i class="fas fa-file"></i>
      <div class="stat-details">
        <span class="stat-value">{{ stats?.by_storage_type?.[activeStorage]?.count || 0 | number }}</span>
        <span class="stat-label">Total Files</span>
      </div>
    </div>
    <div class="stat-card" *ngFor="let statusEntry of getStatusEntries()">
      <i class="fas fa-info-circle"></i>
      <div class="stat-details">
        <span class="stat-value">{{ statusEntry.count | number }}</span>
        <span class="stat-label">{{ statusEntry.status | titlecase }}</span>
      </div>
    </div>
  </div>
  
  <!-- Breadcrumb navigation -->
  <div class="breadcrumb">
    <span 
      *ngFor="let breadcrumbItem of getBreadcrumbItems(); let last = last"
      (click)="!last && navigateToPath(breadcrumbItem.path)"
      [class.active]="!last"
    >
      {{ breadcrumbItem.name || 'Root' }}
      <span *ngIf="!last">/</span>
    </span>
  </div>
  
  <!-- Search and actions -->
  <div class="toolbar">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input 
        type="text" 
        [(ngModel)]="searchTerm"
        (keyup.enter)="onSearch()"
        placeholder="Search files..."
      >
      <button class="btn btn-primary" (click)="onSearch()">
        <i class="fas fa-search"></i> Search
      </button>
    </div>
    
    <div class="actions" *ngIf="selection.selected.length > 0">
      <button class="btn btn-danger" (click)="deleteSelected()">
        <i class="fas fa-trash"></i> Delete ({{ selection.selected.length }})
      </button>
    </div>
  </div>
  
  <!-- Loading indicator -->
  <div class="loading-overlay" *ngIf="isLoading">
    <mat-spinner diameter="40"></mat-spinner>
    <span>Loading...</span>
  </div>
  
  <!-- Error message -->
  <div class="error-message" *ngIf="error && !isLoading">
    <mat-icon color="warn">error</mat-icon>
    <span>{{ error }}</span>
    <button mat-raised-button color="primary" (click)="loadFiles()">Retry</button>
  </div>
  
  <!-- List view -->
  <div class="file-list" *ngIf="!isLoading && !error && viewMode === 'list'">
    <div class="mat-elevation-z8 table-container">
      <table mat-table [dataSource]="dataSource" matSort>
        <!-- Select Column -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox (change)="toggleAllFiles()" [checked]="isAllSelected()"></mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let file">
            <mat-checkbox (click)="$event.stopPropagation()" (change)="toggleFileSelection(file)" [checked]="selection.isSelected(file)"></mat-checkbox>
          </td>
        </ng-container>

        <!-- Filename Column -->
        <ng-container matColumnDef="filename">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Filename</th>
          <td mat-cell *matCellDef="let file">
            <div class="file-name-cell">
              <i class="{{getFileIcon(file.content_type)}} file-icon"></i>
              <span>{{file.filename}}</span>
            </div>
          </td>
        </ng-container>

        <!-- Size Column -->
        <ng-container matColumnDef="size">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Size</th>
          <td mat-cell *matCellDef="let file">{{file.size_formatted}}</td>
        </ng-container>
        
        <!-- Type Column -->
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
          <td mat-cell *matCellDef="let file">{{file.file_type || file.content_type}}</td>
        </ng-container>
        
        <!-- Owner Column -->
        <ng-container matColumnDef="owner">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Owner</th>
          <td mat-cell *matCellDef="let file">
            <span *ngIf="file.owner">{{file.owner}}</span>
            <span *ngIf="!file.owner" class="anonymous-badge">Anonymous</span>
          </td>
        </ng-container>

        <!-- Upload Date Column -->
        <ng-container matColumnDef="upload_date">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Upload Date</th>
          <td mat-cell *matCellDef="let file">{{file.upload_date | date:'medium'}}</td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let file">
            <span class="status-badge" [ngClass]="{
              'status-success': file.status === 'completed' || file.status === 'uploaded',
              'status-warning': file.status === 'processing' || file.status === 'pending',
              'status-error': file.status === 'failed' || file.status === 'error'
            }" [matTooltip]="file.error || ''">
              {{file.status || 'Unknown'}}
            </span>
          </td>
        </ng-container>
        
        <!-- Storage Column -->
        <ng-container matColumnDef="storage">
          <th mat-header-cell *matHeaderCellDef>Storage</th>
          <td mat-cell *matCellDef="let file">
            <span class="storage-badge" [ngClass]="{
              'storage-gdrive': file.storage === 'google_drive',
              'storage-hetzner': file.storage === 'hetzner',
              'storage-both': file.storage === 'both'
            }">
              {{file.storage === 'google_drive' ? 'Google Drive' : 
                file.storage === 'hetzner' ? 'Hetzner' : 
                file.storage === 'both' ? 'Both' : 'Unknown'}}
            </span>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let file">
            <button mat-icon-button color="primary" (click)="syncFile(file.file_id)" matTooltip="Sync Status">
              <i class="fas fa-sync-alt"></i>
            </button>
            <button mat-icon-button color="warn" 
                    (click)="deleteFile(file.file_id, activeStorage === 'google_drive' ? 'google-drive' : 'hetzner')" 
                    matTooltip="Delete"
                    [disabled]="activeStorage === 'google_drive' && file.storage !== 'hetzner'">
              <i class="fas fa-trash"></i>
            </button>
            <a mat-icon-button color="accent" [href]="file.url" target="_blank" matTooltip="Download" *ngIf="file.url">
              <i class="fas fa-download"></i>
            </a>
          </td>
        </ng-container>
      
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr 
        mat-row 
        *matRowDef="let row; columns: displayedColumns;"
        [class.directory]="row.is_directory"
        (click)="row.is_directory ? navigateToPath(row.path) : null"
      ></tr>
    </table>
    
    <mat-paginator 
      [length]="totalFiles"
      [pageSize]="pageSize"
      [pageSizeOptions]="[10, 25, 50, 100]"
      (page)="onPageChange($event)"
      showFirstLastButtons>
    </mat-paginator>
  </div>
  
  <!-- Grid view -->
  <div class="file-grid" *ngIf="!isLoading && !error && isGridView()">
    <div 
      *ngFor="let file of dataSource.data"
      class="file-card"
      [class.directory]="file.is_directory"
      (click)="file.is_directory ? navigateToPath(file.path) : null"
    >
      <div class="file-icon">
        <i [class]="getFileIcon(file.content_type)" [class.fa-folder]="file.is_directory"></i>
      </div>
      <div class="file-info">
        <div class="filename" [matTooltip]="file.filename">{{ file.filename }}</div>
        <div class="file-meta">
          <span *ngIf="!file.is_directory">{{ formatFileSize(file.size_bytes) }}</span>
          <span>{{ file.upload_date | date:'short' }}</span>
        </div>
        <div class="file-status">
          <span class="status-badge" [ngClass]="file.status?.toLowerCase()">
            {{ file.status || 'Unknown' }}
          </span>
          <span class="error-message" *ngIf="file.error" [matTooltip]="file.error">
            <i class="fas fa-exclamation-circle"></i>
          </span>
        </div>
      </div>
      <div class="file-actions">
        <button 
          mat-icon-button 
          matTooltip="Sync status"
          (click)="$event.stopPropagation(); syncFile(file.file_id)"
          [disabled]="isLoading"
        >
          <i class="fas fa-sync-alt"></i>
        </button>
        <button 
          mat-icon-button 
          color="warn"
          matTooltip="Delete file"
          (click)="$event.stopPropagation(); deleteFile(file.file_id, activeStorage === 'google_drive' ? 'google-drive' : 'hetzner')"
          [disabled]="isLoading"
        >
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Empty state -->
  <div class="empty-state" *ngIf="!isLoading && !error && dataSource.data.length === 0">
    <i class="fas fa-folder-open"></i>
    <h3>No files found</h3>
    <p>There are no files in this location.</p>
  </div>
</div>
